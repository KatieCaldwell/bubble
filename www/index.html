<!DOCTYPE html>
<html>
<head>
<title>corner</title>
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
<meta charset="utf-8"/>
<style type="text/css">
  * {
    margin: 0;
    padding: 0;
  }
  #container {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    right: 0;
    overflow: hidden;
  }
  #add {
    position: absolute;
    margin: 0 auto;
    width: 7rem;
    bottom: 1rem;
    left: 0;
    right: 0;
    text-align: center;
  }
  #pov {
    position: absolute;
    margin: 0 auto;
    width: 7rem;
    top: 1rem;
    right: 1rem;
    background-color: silver;
  }
  #msg {
    position: absolute;
    margin: 0 auto;
    width: 20rem;
    height: 10rem;
    top: 1rem;
    background-color: silver;
    padding: 1rem;
    visibility: hidden;
  }
</style>
</head>
<body>
<div id="container"></div>
<div id="add">
  <img src="images/plus.png">
</div>
<div id="pov"></div>
<div id="msg">
  <textarea>default text</textarea>
</div>
<script type="text/javascript" defer src="js/hammer.min.js"></script>
<script type="text/javascript" defer src="js/awe-loader-min.js"></script>
<script type="text/javascript">
window.addEventListener('DOMContentLoaded', function() {
    var capabilities = location.search.indexOf('desktop') != -1 ?
          ['gum','webgl'] : ['gum','gyro','webgl'];
    console.log(capabilities)
  // initialize awe after page loads
  awe.init({
    // automatically detect the device type
    device_type: awe.AUTO_DETECT_DEVICE_TYPE,
    // populate some default settings
    settings: {
      container_id: 'container',
      fps: 5,
      default_camera_position: { x:0, y:0, z:0 },
      default_lights:[{
        id: 'point_light',
        type: 'point',
        color: 0xFFFFFF
      }],
    },
    ready: function() {
      // load js files based on capability detection then setup the scene if successful
      awe.util.require([{
          capabilities: capabilities,
          files: [ 
            ['js/awe-standard-dependencies.js', 'js/awe-standard.js' ], // core dependencies for this app 
            'js/awe-standard-window_resized.js', // window resize handling plugin
            'js/awe-standard-object_clicked.js', // object click/tap handling plugin
            'awe.geo_ar.js', // geo ar plugin
          ],
          success: onAweReady,
        },
        { // else create a fallback
          capabilities: [],
          files: [],
          success: function() { 
            document.body.innerHTML = '<p>This demo currently requires a standards compliant mobile browser (e.g. Firefox on Android). NOTE: iOS does not currently support WebGL or WebRTC and has not implemented the DeviceOrientation API correctly. Please see <a href="http://lists.w3.org/Archives/Public/public-geolocation/2014Jan/0000.html">this post to the W3C GeoLocation Working Group</a> for more detailed information.</p>';
            return;
          },
        },
      ]);
    }
  });
});

function onAweReady() {
  // limit demo to supported devices
  // NOTE: only Chrome and Firefox has implemented the DeviceOrientation API in a workable way
  //       so for now we are excluding all others to make sure your first experience is a happy one
  var device_type = awe.device_type();
  var browser_unsupported = false;
  if (device_type != 'android' && 
      !navigator.userAgent.match(/chrome|firefox/i)) {
    document.body.innerHTML = '<p>This demo currently requires a standards compliant Android browser (e.g. Chrome M33).</p>';
    return;
  }

  window.addEventListener('devicemotion', function(e) {
    console.log('motion')
  }, false);

  // Our own orientation listener
  var pov = { x: 0, y: 0, z: 0 };
  window.addEventListener('deviceorientation', function(e) {
    console.log(orientation, e);
    var alpha = e.alpha,
        beta = e.beta,
        gamma = e.gamma,
        x = 0,
        y = 0,
        z = 0;

    if ((beta > 30 && beta < 150) || // device is generally upright (portrait)
        (beta < -30 && beta > -150)) { // device is generally upright but inverted (portrait)
      x = beta+90;
      y = (alpha+gamma)%360;
      z = 180;
    } else { // device is generally not-upright (landscape)
      if (gamma < 0 && gamma > -90) { // rotation below horizon
        x = -gamma-90;
      } else { // rotation above horizon
        x = 90-gamma;
      }
      y = (alpha+gamma+180)%360;
    }

    var povEl = document.querySelector('#pov');
    povEl.innerHTML = ['X', Math.round(x), 'Y', Math.round(y)].join(' ');
    pov = { x: Math.round(x), y: Math.round(y), z: Math.round(z) };
  });

  // setup and paint the scene
  awe.setup_scene();

  var addBtn = document.querySelector('#add');
  var hammertime = new Hammer(addBtn);
  hammertime.on('tap', newMessage);
  
  function newMessage(e) {
    var povEl = document.querySelector('#pov');
    var id = 'msg' + Date.now();
    awe.pois.add({ id: id, position: { x: 0, y: 0, z:200 } });
    //alert('adding new msg at ' + pov.x + ', ' + pov.y)
    //awe.pois.add({ id: id, position: { x: pov.x, y: pov.y, z:200 } });
    //awe.pois.add({ id: id, position: { x: 175, y: 118, z:200 } });
    awe.projections.add({ 
      id: id,
      geometry:{ shape:'cube', x:100, y:50, z:10 },
      position: { x: 0, y: 0, z: 0 },
      material:{ color: 0xC0C0C0 },
      texture: { path: 'images/envelope.png' },
    }, { poi_id: id });

    // show message editor
    var msg = document.querySelector('#msg');
    msg.style.visible = 'visible';
  }

  window.addEventListener('object_clicked', function(e) {
    // e.detail.projection_id
  });
  
  // save all poi/projections to json
  function serializeSession() {
  }

  // send session to server
  function saveSession() {
  }

  // load session from server
  function loadSession() {
  }
}
</script>
</body>
</html>
